services:
  chain:
    build:
      context: .
      dockerfile: Dockerfile.chain
    restart: always
    entrypoint: /usr/local/bin/anvil
    command: --fork-url ${ETH_RPC_URL} --block-time 12
    environment:
      - ANVIL_IP_ADDR=0.0.0.0
    ports:
      - 8545:8545
    healthcheck:
      # The healthcheck is actually a little hack that replaces the allow-list manager
      # with simple bytecode that always returns a solidity `true` value, alleviating
      # the requirement to register a solver's private key for the sake of testing on
      # a fork.
      test: [ "CMD-SHELL", "
          response=$$(wget -qO- --header='Content-Type: application/json' --post-data='{\"jsonrpc\":\"2.0\", \"method\":\"eth_blockNumber\", \"params\":[], \"id\":1}' http://127.0.0.1:8545);
          block=$$(echo $$response | sed -n 's/.*\"result\":\"\\([^\"\\]*\\)\".*/\\1/p');
          if [ -n \"$$block\" ] && [ \"$$block\" != \"0x0\" ] && [ \"$$block\" != \"null\" ]; then
            /usr/local/bin/cast rpc -r http://127.0.0.1:8545 anvil_setCode 0x2c4c28DDBdAc9C5E7055b4C863b72eA0149D8aFE 0x600160005260206000F3;
            exit 0;
          else
            exit 1;
          fi;
        " ]
      interval: 5s
      timeout: 30s
      retries: 5
      start_period: 5s

  db:
    image: postgres:16
    restart: always
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - POSTGRES_HOST_AUTH_METHOD=trust
    command: -d postgres
    volumes:
      - postgres:/var/lib/postgresql/data
    ports:
      - 5432:5432

  adminer:
    image: adminer
    restart: always
    ports:
      - 8082:8080
    depends_on:
      - db

  db-migrations:
    build:
      context: ../
      target: migrations
      dockerfile: ./playground/Dockerfile
    restart: on-failure
    environment:
      - FLYWAY_URL=jdbc:postgresql://db/?user=${POSTGRES_USER}&password=${POSTGRES_PASSWORD}
    depends_on:
      - db

  orderbook:
    build:
      context: ../
      target: localdev
      dockerfile: ./playground/Dockerfile
    restart: always
    command: ["cargo", "watch", "-x", "run --bin orderbook"]
    environment:
      - NODE_URL=http://chain:8545
      - DB_WRITE_URL=postgres://db:5432/?user=${POSTGRES_USER}&password=${POSTGRES_PASSWORD}
      - DB_READ_URL=postgres://db:5432/?user=${POSTGRES_USER}&password=${POSTGRES_PASSWORD}
      - ACCOUNT_BALANCES_SIMULATION=true
      - ACCOUNT_BALANCES_SIMULATOR=Web3
      - SIMULATION_NODE_URL=http://chain:8545
      - EIP1271_SKIP_CREATION_VALIDATION=true
      - ENABLE_EIP1271_ORDERS=true
      - PRICE_ESTIMATORS=None
      - PRICE_ESTIMATION_DRIVERS=baseline|http://driver/baseline
      - NATIVE_PRICE_ESTIMATORS=Driver|baseline|http://driver/baseline
      - DRIVERS=baseline|http://driver/baseline
      - BIND_ADDRESS=0.0.0.0:80
      - CHAIN_ID=$CHAIN
      - BASELINE_SOURCES=None
      - RUST_BACKTRACE=1
      - TOML_TRACE_ERROR=1
      - TRACING_COLLECTOR_ENDPOINT=http://tempo:4317
      - TOKIO_CONSOLE=true
      - TOKIO_CONSOLE_RETENTION=600sec
      - TOKIO_CONSOLE_BIND=0.0.0.0:6669
    volumes:
      - ../:/src
    depends_on:
      - db-migrations
    ports:
      - 8080:80 # API
      - 9586:9586 # metrics
      - 6669:6669 # tokio console

  autopilot:
    build:
      context: ../
      target: localdev
      dockerfile: ./playground/Dockerfile
    restart: always
    command: ["cargo", "watch", "-x", "run --bin autopilot"]
    environment:
      - DB_WRITE_URL=postgres://db:5432/?user=${POSTGRES_USER}&password=${POSTGRES_PASSWORD}
      - DB_READ_URL=postgres://db:5432/?user=${POSTGRES_USER}&password=${POSTGRES_PASSWORD}
      - LOG_FILTER=warn,autopilot=debug,shared=info,shared::price_estimation=info
      - NODE_URL=http://chain:8545
      - SIMULATION_NODE_URL=http://chain:8545
      - SETTLE_INTERVAL=15s
      - GAS_ESTIMATORS=Web3
      - PRICE_ESTIMATORS=None
      - BLOCK_STREAM_POLL_INTERVAL=1s
      - NATIVE_PRICE_CACHE_MAX_UPDATE_SIZE=100
      - NATIVE_PRICE_CACHE_MAX_AGE=20m
      - SOLVER_TIME_LIMIT=5
      - PRICE_ESTIMATION_DRIVERS=baseline|http://driver/baseline
      - NATIVE_PRICE_ESTIMATORS=Driver|baseline|http://driver/baseline
      - DRIVERS=baseline|http://driver/baseline|0xa0Ee7A142d267C1f36714E4a8F75612F20a79720
      - SKIP_EVENT_SYNC=true
      - BASELINE_SOURCES=None
      - RUST_BACKTRACE=1
      - TOML_TRACE_ERROR=1
      - ETHFLOW_CONTRACTS
      - ETHFLOW_INDEXING_START
      - TOKIO_CONSOLE=true
      - TOKIO_CONSOLE_RETENTION=600sec
      - TOKIO_CONSOLE_BIND=0.0.0.0:6669
    volumes:
      - ../:/src
    depends_on:
      orderbook:
        condition: service_started
      chain:
        condition: service_healthy
    ports:
      - 9589:9589 # metrics
      - 6670:6669 # tokio console

  driver:
    build:
      context: ../
      target: localdev
      dockerfile: ./playground/Dockerfile
    restart: always
    command:
      [
        "cargo",
        "watch",
        "-x",
        "run --bin driver -- --config configs/${ENV}/driver.toml",
      ]
    environment:
      - ETHRPC=http://chain:8545
      - ADDR=0.0.0.0:80
      - RUST_BACKTRACE=1
      - TOML_TRACE_ERROR=1
      - TRACING_COLLECTOR_ENDPOINT=http://tempo:4317
      - TOKIO_CONSOLE=true
      - TOKIO_CONSOLE_RETENTION=600sec
      - TOKIO_CONSOLE_BIND=0.0.0.0:6669
    volumes:
      - ../:/src
    ports:
      - 9000:80 # API & metrics
      - 6671:6669 # tokio console
    depends_on:
      chain:
        condition: service_healthy

  # baseline (solver engine)
  baseline:
    build:
      context: ../
      target: localdev
      dockerfile: ./playground/Dockerfile
    restart: always
    command:
      [
        "cargo",
        "watch",
        "-x",
        "run --bin solvers -- baseline --config configs/${ENV}/baseline.toml",
      ]
    environment:
      - ADDR=0.0.0.0:80
      - LOG=solvers=trace,shared=trace
      - RUST_BACKTRACE=1
      - TOML_TRACE_ERROR=1
      - TOKIO_CONSOLE=true
      - TOKIO_CONSOLE_RETENTION=600sec
      - TOKIO_CONSOLE_BIND=0.0.0.0:6669
    volumes:
      - ../:/src
    ports:
      - 9001:80 # API & metrics
      - 6672:6669 # tokio console

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.cowswap
      args:
        - CHAIN=$CHAIN
        - ETH_RPC_URL=http://127.0.0.1:8545
    ports:
      - 8000:80

  # Sourcify - Contract verification service
  sourcify-db:
    image: postgres:16
    restart: always
    environment:
      - POSTGRES_USER=sourcify
      - POSTGRES_PASSWORD=sourcify
      - POSTGRES_DB=sourcify
    volumes:
      - sourcify-postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sourcify"]
      interval: 5s
      timeout: 5s
      retries: 5

  sourcify:
    build:
      context: .
      dockerfile: Dockerfile.sourcify
    restart: always
    depends_on:
      sourcify-db:
        condition: service_healthy
    environment:
      - SOURCIFY_POSTGRES_HOST=sourcify-db
      - SOURCIFY_POSTGRES_PORT=5432
      - SOURCIFY_POSTGRES_USER=sourcify
      - SOURCIFY_POSTGRES_PASSWORD=sourcify
      - SOURCIFY_POSTGRES_DB=sourcify
      - NODE_ENV=development
    volumes:
      - ./sourcify-chains.json:/sourcify/services/server/dist/sourcify-chains.json
    ports:
      - 5555:5555
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  otterscan:
    build:
      context: .
      dockerfile: Dockerfile.otterscan
    restart: always
    environment:
      - ERIGON_URL=http://127.0.0.1:8545
      - SOURCIFY_MODE=${SOURCIFY_MODE:-cloud}
      - LOCAL_SOURCIFY_URL=http://sourcify:5555
    ports:
      - 8003:80
    depends_on:
      chain:
        condition: service_healthy
      sourcify:
        condition: service_healthy

  explorer:
    build:
      context: .
      dockerfile: Dockerfile.explorer
      args:
        - CHAIN=$CHAIN
        - ETH_RPC_URL=http://chain:8545
    ports:
      - 8001:80

  tempo:
    image: grafana/tempo:latest
    ports:
      - "4317:4317" # OTLP gRPC
    command: ["-config.file=/etc/tempo.yaml"]
    volumes:
      - ./tempo.yaml:/etc/tempo.yaml

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true
    volumes:
      - ./grafana-prometheus.yml:/etc/grafana/provisioning/datasources/prometheus.yml

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: always
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml

volumes:
  postgres:
  sourcify-postgres:
