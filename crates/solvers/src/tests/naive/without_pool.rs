//! This test verifies that the naive solver doesn't use liquidity from the pool
//! when order amounts overlap.

use {crate::tests, serde_json::json};

#[tokio::test]
async fn test() {
    let engine = tests::SolverEngine::new("naive", None).await;

    let solution = engine
        .solve(json!({
            "id": null,
            "tokens": {},
            "orders": [
                {
                    "uid": "0x0101010101010101010101010101010101010101010101010101010101010101\
                              0101010101010101010101010101010101010101\
                              01010101",
                    "sellToken": "0x000000000000000000000000000000000000000a",
                    "buyToken": "0x000000000000000000000000000000000000000b",
                    "sellAmount": "1001000000000000000000",
                    "buyAmount": "1000000000000000000000",
                    "feeAmount": "0",
                    "kind": "sell",
                    "partiallyFillable": false,
                    "class": "market",
                    "reward": 0.,
                },
                {
                    "uid": "0x0202020202020202020202020202020202020202020202020202020202020202\
                              0202020202020202020202020202020202020202\
                              02020202",
                    "sellToken": "0x000000000000000000000000000000000000000b",
                    "buyToken": "0x000000000000000000000000000000000000000a",
                    "sellAmount": "1001000000000000000000",
                    "buyAmount": "1000000000000000000000",
                    "feeAmount": "0",
                    "kind": "sell",
                    "partiallyFillable": false,
                    "class": "market",
                    "reward": 0.,
                },
            ],
            "liquidity": [
                {
                    "kind": "constantproduct",
                    "tokens": {
                        "0x000000000000000000000000000000000000000a": {
                            "balance": "1000001000000000000000000"
                        },
                        "0x000000000000000000000000000000000000000b": {
                            "balance": "1000000000000000000000000"
                        }
                    },
                    "fee": "0.003",
                    "id": "0",
                    "address": "0xffffffffffffffffffffffffffffffffffffffff",
                    "gasEstimate": "110000"
                },
            ],
            "effectiveGasPrice": "15000000000",
            "deadline": "2106-01-01T00:00:00.000Z",
        }))
        .await;

    assert_eq!(
        solution,
        json!({
            "prices": {
                "0x000000000000000000000000000000000000000a": "1000000000000000000000000",
                "0x000000000000000000000000000000000000000b": "1000001000000000000000000",
            },
            "trades": [
                {
                    "kind": "fulfillment",
                    "order": "0x0101010101010101010101010101010101010101010101010101010101010101\
                                0101010101010101010101010101010101010101\
                                01010101",
                    "executedAmount": "1001000000000000000000",
                },
                {
                    "kind": "fulfillment",
                    "order": "0x0202020202020202020202020202020202020202020202020202020202020202\
                                0202020202020202020202020202020202020202\
                                02020202",
                    "executedAmount": "1001000000000000000000",
                },
            ],
            "interactions": [],
        }),
    );
}
